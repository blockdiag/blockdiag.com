

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>blockdiag レンダラプラグインの作り方 &mdash; How to create blockdiag renderer plug-in v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="How to create blockdiag renderer plug-in v1.0 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">How to create blockdiag renderer plug-in v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="blockdiag">
<h1>blockdiag レンダラプラグインの作り方<a class="headerlink" href="#blockdiag" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>blockdiag レンダラプラグインとは<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>blockdiag は <a class="reference external" href="http://tk0miya.bitbucket.org/blockdiag/build/html/examples.html#shape-of-nodes">サンプル</a> のように
各ノードの形状を変化させることができます。</p>
<p>この各ノードの形状をレンダリングするプログラムが
blockdiag レンダラ(blockdiag node renderer)です。
blockdiag レンダラは setuptools を利用したプラグイン構造になっているため、
標準のパーツでは物足りない場合に好きな形状を組み込むことができます。</p>
</div>
<div class="section" id="id3">
<h2>blockdiag レンダラを作ろう<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>ここでは blockdiag レンダラのサンプルである <cite>blockdiagcontrib-square</cite> を参考に、
プラグインの作り方を説明します。
blockdiagcontrib-square は正方形の形状を描画するためのサンプルレンダラです。</p>
<p>hg コマンドで blockdiagcontrib-square を取得しておくと参考になるでしょう。</p>
<div class="highlight-none"><div class="highlight"><pre>% hg clone https://bitbucket.org/tk0miya/blockdiagcontrib-square/src
</pre></div>
</div>
<div class="section" id="id4">
<h3>レンダラパッケージの構成<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>レンダラパッケージは以下のファイルで構成されます。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">ファイル名</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>README.txt</td>
<td>blockdiag レンダラの説明書です。</td>
</tr>
<tr><td>bootstrap.py</td>
<td>buildout 構成ファイルです。</td>
</tr>
<tr><td>buildout.cfg</td>
<td>buildout 構成ファイルです。</td>
</tr>
<tr><td>setup.py</td>
<td>setuptools 用の設定ファイルです。
パッケージ名やプラグイン用の設定を行います。</td>
</tr>
<tr><td>MANIFEST.in</td>
<td>パッケージング用の構成ファイルです。</td>
</tr>
<tr><td>blockdiagcontrib/__init__.py</td>
<td>&nbsp;</td>
</tr>
<tr><td>blockdiagcontrib/square.py</td>
<td>blockdiag レンダラの本体です。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="setup-py">
<h3>パッケージの情報を設定する：setup.py<a class="headerlink" href="#setup-py" title="Permalink to this headline">¶</a></h3>
<p>setup.py にはレンダラのパッケージ情報が記載されています。
必要に応じ適切な情報に書き換えてください。
主な書き換え箇所はパッケージ名(name)、作者の情報(author, author_email, url) です。</p>
<div class="highlight-python"><pre>setup(
     name='blockdiagcontrib-square',
     version=version,
     description='noderenderer plugin for blockdiag',
     long_description=long_description,
     classifiers=classifiers,
     keywords=['diagram','generator'],
     author='Takeshi Komiya',
     author_email='i.tkomiya at gmail.com',
     url='http://tk0miya.bitbucket.org/blockdiag/build/html/index.html',
     license='PSL',</pre>
</div>
<p>また、パッケージ名に合わせて entry_points も書き換えます。
(square を置き換える)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">entry_points</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">   [blockdiag_noderenderer]</span>
<span class="s">   square = blockdiagcontrib.square</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>blockdiag レンダラを書き換える<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="section" id="init">
<h4>図形の情報を設定する：__init__()<a class="headerlink" href="#init" title="Permalink to this headline">¶</a></h4>
<p>__init__() メソッドではノード描画の基本設定を行います。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">パラメータ名</th>
<th class="head">意味</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>node</td>
<td>描画対象となるノードです。
blockdiag.element.DiagramNode のインスタンスです。</td>
</tr>
<tr><td>metrix</td>
<td>座標を決める際に利用するパラメータ情報です。
blockdiag.DiagramMetrix.DiagramMetrix のインスタンスです。</td>
</tr>
</tbody>
</table>
<p>__init__() メソッドで設定できる項目はエッジの接点とテキスト描画領域の二つです。</p>
<dl class="docutils">
<dt>エッジの接点</dt>
<dd>他の図形からのエッジ(矢印)が接続される接点を定義します。
設定箇所は上下左右の 4箇所です。
self.connectors 配列に 上、右、下、左 の順で座標を格納します。
初期値はセルの上下左右の四辺の中心です。</dd>
<dt>テキスト描画領域</dt>
<dd><p class="first">テキストを描画する箇所を定義します。
self.textarea 配列に描画虜域の x1, y1, x2, y2 座標を格納します。
初期値はセル領域全体です。</p>
<p class="last">参考：minidiamond や endpoint などのレンダラでは、
図形が小さいため描画領域を図形の外側に配置しています。</p>
</dd>
</dl>
<p>ノードの基本系である Box (長方形)から設定を変更する必要がない場合は、
特別に設定を行う必要はありません。
なお、__init__() メソッドを定義する場合は
かならず super() 関数で親クラスの __init__() を呼び出す必要があります。</p>
<p>以下、blockdiagcontrib-square の説明。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">metrix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># 初期化処理：かならず super() を呼ぶこと</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Square</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">metrix</span><span class="p">)</span>

    <span class="c"># ノードの縦、横の短い辺を求める</span>
    <span class="c"># 図形を大きくするため、少しだけ(cellSize 分)大きくする</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">metrix</span><span class="o">.</span><span class="n">nodeWidth</span><span class="p">,</span> <span class="n">metrix</span><span class="o">.</span><span class="n">nodeHeight</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">metrix</span><span class="o">.</span><span class="n">cellSize</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c"># ノードの中心座標を求める</span>
    <span class="c"># 他にも左上、右上などの座標を調べることができます。</span>
    <span class="c"># (See blockdiag.DiagramMetrix.NodeMetrix)</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">metrix</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>

    <span class="c"># 接点を設定する (配列は上、右、下、左の順)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">XY</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span>  <span class="c"># top</span>
                       <span class="n">XY</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>  <span class="c"># right</span>
                       <span class="n">XY</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span>  <span class="c"># bottom</span>
                       <span class="n">XY</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>  <span class="c"># left</span>

    <span class="c"># テキスト描画領域を設定する (正方形と同じ大きさに設定)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">textbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="render-shape">
<h4>図形を描画する：render_shape()<a class="headerlink" href="#render-shape" title="Permalink to this headline">¶</a></h4>
<p>render_shape() メソッドではノードの描画を行います。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">パラメータ名</th>
<th class="head">意味</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>drawer</td>
<td>描画エンジンです。
フォーマットにあわせて ImageDrawEx, SVGImageDraw, PDFImageDraw の
いずれかが渡されます。</td>
</tr>
<tr><td>format</td>
<td>出力フォーマットです。&#8217;PNG&#8217;, &#8216;SVG&#8217;, &#8216;PDF&#8217; のいずれかが渡されます。</td>
</tr>
<tr><td>**kwargs</td>
<td><p class="first">描画パラメータです。</p>
<dl class="last docutils">
<dt>kwargs[&#8216;shadow&#8217;]</dt>
<dd>影を描画する場合に True が指定されます。</dd>
<dt>kwargs[&#8216;outline&#8217;]</dt>
<dd>図形の線を描画するときの色が指定されます。</dd>
<dt>kwargs[&#8216;fill&#8217;]</dt>
<dd>図形を塗りつぶすときの色が指定されます。</dd>
</dl>
</td>
</tr>
</tbody>
</table>
<p>render_shape() メソッドでは渡されるパラメータによって、
以下のように動きを変える必要があります。</p>
<ul>
<li><dl class="first docutils">
<dt>kwargs[&#8216;shadow&#8217;] が指定された場合は影を描画する</dt>
<dd><ul class="first last">
<li><p class="first">黒く塗りつぶされた図形を描画する必要がある</p>
</li>
<li><dl class="first docutils">
<dt>描画エリアの内側の装飾は描画しなくてもよい</dt>
<dd><ul class="first last simple">
<li>note の内側に折れた部分、mail の封筒のふた部分など</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>背景画像(self.node.background)が設定されている場合</dt>
<dd><ul class="first last simple">
<li>図形の塗りつぶし、画像の読み込み、線の順に描画する</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>以下、blockdiagcontrib-square の説明。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">render_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawer</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">outline</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;outline&#39;</span><span class="p">)</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;fill&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;shadow&#39;</span><span class="p">):</span>
        <span class="c"># 影を描画する</span>
        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_shadow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">textbox</span><span class="p">)</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                       <span class="nb">filter</span><span class="o">=</span><span class="s">&#39;transp-blur&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">background</span><span class="p">:</span>
        <span class="c"># 背景画像がある場合は塗りつぶし→画像→外枠の順に描する</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">textbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">color</span><span class="p">,</span>
                         <span class="n">outline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">loadImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">textbox</span><span class="p">)</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">textbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="n">outline</span><span class="p">,</span>
                         <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># 普通に描画する</span>
        <span class="n">drawer</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">textbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">color</span><span class="p">,</span>
                         <span class="n">outline</span><span class="o">=</span><span class="n">outline</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setup">
<h4>レンダラをインストールする：setup()<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h4>
<p>setup() 関数ではレンダラのインストールを行います。
install_renderer() 関数にパッケージ名とレンダラクラスを渡します。</p>
<p>ここで登録した名称が .diag ファイルで指定される名称になります。</p>
<p>以下、blockdiagcontrib-square の説明。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># square という名称でレンダラクラスを登録</span>
    <span class="c"># → hoge [shape = square] として利用可能になる</span>
    <span class="n">install_renderer</span><span class="p">(</span><span class="s">&#39;square&#39;</span><span class="p">,</span> <span class="n">Square</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>blockdiag レンダラの公開<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3>blockdiag 本体への取り込み<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>よく使われそうなレンダラは blockdiag と一緒に配布すると
他のユーザも幸せになれると思います。</p>
<p>素敵なレンダラを作った場合は &#64;tk0miya に声をかけてください。</p>
</div>
<div class="section" id="pypi">
<h3>PyPI での公開<a class="headerlink" href="#pypi" title="Permalink to this headline">¶</a></h3>
<p>&#64;shimizukawa の <a class="reference external" href="http://www.freia.jp/taka/docs/pyhack4/pypi/index.html">PyPIデビュー</a> あたりを一読してから以下のコマンドを叩くとよいでしょう。</p>
<div class="highlight-none"><div class="highlight"><pre>setup.py register sdist upload
</pre></div>
</div>
<p>PyPI にレンダラをアップロードした後、&#64;tk0miya に声をかけると喜びます。</p>
</div>
</div>
<div class="section" id="id9">
<h2>その他参考情報<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>より深い情報が必要な場合は blockdiag に同梱されている
レンダラの実装を参照してください。</p>
</div>
<div class="section" id="api">
<h2>描画 API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>あとで書く(予定)。</p>
<p>それまでは blockdiag.ImageDrawEx に定義されている関数を見てください。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">blockdiag レンダラプラグインの作り方</a><ul>
<li><a class="reference internal" href="#id1">blockdiag レンダラプラグインとは</a></li>
<li><a class="reference internal" href="#id3">blockdiag レンダラを作ろう</a><ul>
<li><a class="reference internal" href="#id4">レンダラパッケージの構成</a></li>
<li><a class="reference internal" href="#setup-py">パッケージの情報を設定する：setup.py</a></li>
<li><a class="reference internal" href="#id5">blockdiag レンダラを書き換える</a><ul>
<li><a class="reference internal" href="#init">図形の情報を設定する：__init__()</a></li>
<li><a class="reference internal" href="#render-shape">図形を描画する：render_shape()</a></li>
<li><a class="reference internal" href="#setup">レンダラをインストールする：setup()</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id6">blockdiag レンダラの公開</a><ul>
<li><a class="reference internal" href="#id7">blockdiag 本体への取り込み</a></li>
<li><a class="reference internal" href="#pypi">PyPI での公開</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">その他参考情報</a></li>
<li><a class="reference internal" href="#api">描画 API</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">How to create blockdiag renderer plug-in v1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Takeshi Komiya.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>